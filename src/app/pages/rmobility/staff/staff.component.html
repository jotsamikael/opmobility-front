<div class="container-fluid">
  <app-page-title title="Staff Management" [breadcrumbItems]="breadCrumbItems"></app-page-title>
  
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
         <!-- Header with title and create button -->
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
              <h4 class="card-title mb-1">Staff Management</h4>
              <p class="text-muted mb-0">Manage and monitor your staff members</p>
            </div>
            <button mat-raised-button color="primary" (click)="onCreateStaff()" class="d-flex align-items-center">
              <mat-icon class="me-1">person_add</mat-icon>
              Create New Staff
            </button>
          </div>
          
          <!-- Summary Cards -->
          <div class="row mb-4" *ngIf="!isLoading">
            <div class="col-md-3">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                      <h6 class="text-muted mb-1">Total Staff</h6>
                      <h3 class="mb-0">{{totalItems}}</h3>
                    </div>
                    <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                      <mat-icon style="color: #556ee6;">people</mat-icon>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                      <h6 class="text-muted mb-1">Active Staff</h6>
                      <h3 class="mb-0">{{activeStaffCount}}</h3>
                    </div>
                    <div class="bg-success bg-opacity-10 rounded-circle p-3">
                      <mat-icon style="color: #34c38f;">check_circle</mat-icon>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                      <h6 class="text-muted mb-1">Inactive Staff</h6>
                      <h3 class="mb-0">{{inactiveStaffCount}}</h3>
                    </div>
                    <div class="bg-danger bg-opacity-10 rounded-circle p-3">
                      <mat-icon style="color: #f46a6a;">block</mat-icon>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center">
                    <div class="flex-grow-1">
                      <h6 class="text-muted mb-1">Current Page</h6>
                      <h3 class="mb-0">{{currentPage}} / {{totalPages}}</h3>
                    </div>
                    <div class="bg-info bg-opacity-10 rounded-circle p-3">
                      <mat-icon style="color: #50a5f1;">list</mat-icon>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Filters Section -->
          <div class="card mb-3">
            <div class="card-body">
              <h5 class="card-title mb-3">
                <mat-icon class="me-2">filter_list</mat-icon>
                Filters
              </h5>
              <div class="row g-3">
                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Search by Email</mat-label>
                    <input matInput [formControl]="emailSearchControl" placeholder="Enter email">
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>
                </div>
                
                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Search by Phone</mat-label>
                    <input matInput [formControl]="phoneSearchControl" placeholder="Enter phone">
                    <mat-icon matSuffix>phone</mat-icon>
                  </mat-form-field>
                </div>
                
                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Created Date</mat-label>
                    <input matInput [matDatepicker]="picker" [formControl]="createdDateControl" placeholder="Select date">
                    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                    <mat-datepicker #picker></mat-datepicker>
                  </mat-form-field>
                </div>
                
                <div class="col-md-3">
                  <mat-form-field appearance="outline" class="w-100">
                    <mat-label>Role</mat-label>
                    <mat-select [formControl]="roleFilter">
                      <mat-option [value]="null">All Roles</mat-option>
                      <mat-option *ngFor="let role of roleOptions" [value]="role.code">
                        {{role.code}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
              
              <!-- Filter Actions -->
              <div class="row mt-2">
                <div class="col-12">
                  <button mat-raised-button color="primary" (click)="applyFilters()" class="me-2">
                    <mat-icon>filter_list</mat-icon>
                    Apply Filters
                  </button>
                  <button mat-stroked-button (click)="clearFilters()" class="me-2">
                    <mat-icon>clear</mat-icon>
                    Clear Filters
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading Spinner -->
          <div *ngIf="isLoading" class="text-center py-4">
            <mat-spinner diameter="40"></mat-spinner>
            <p class="mt-2">Loading staff data...</p>
          </div>

          <!-- Table -->
          <div class="table-responsive" *ngIf="!isLoading">
            <div class="mat-elevation-z8 rounded overflow-hidden">
              <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)" class="w-100">

                <!-- Profile Picture Column -->
                <ng-container matColumnDef="profile">
                  <th mat-header-cell *matHeaderCellDef> Profile </th>
                  <td mat-cell *matCellDef="let row"> 
                    <img *ngIf="row.profilePictureUrl" 
                         [src]="row.profilePictureUrl" 
                         class="rounded-circle" 
                         width="40" 
                         height="40" 
                         style="object-fit: cover;"
                         (error)="onImageError($event)">
                    <div *ngIf="!row.profilePictureUrl" 
                         class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                         style="width: 40px; height: 40px; font-size: 16px; font-weight: bold;">
                      {{row.firstName?.charAt(0)}}{{row.lastName?.charAt(0)}}
                    </div>
                  </td>
                </ng-container>

                <!-- Name Column -->
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header="firstName"> Name </th>
                  <td mat-cell *matCellDef="let row"> 
                    <div>
                      <div class="fw-semibold">{{row.firstName}} {{row.lastName}}</div>
                      <small class="text-muted d-flex align-items-center mt-1">
                        <mat-icon style="font-size: 14px; width: 14px; height: 14px; margin-right: 4px;">email</mat-icon>
                        {{row.email}}
                      </small>
                    </div>
                  </td>
                </ng-container>

                <!-- Phone Column -->
                <ng-container matColumnDef="phone">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Phone </th>
                  <td mat-cell *matCellDef="let row"> 
                    <div class="d-flex align-items-center">
                      <mat-icon class="me-2" style="font-size: 18px; width: 18px; height: 18px;">phone</mat-icon>
                      <span>{{row.phone}}</span>
                    </div>
                  </td>
                </ng-container>

                <!-- Role Column -->
                <ng-container matColumnDef="role">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Role </th>
                  <td mat-cell *matCellDef="let row"> 
                    <span class="badge bg-primary">{{row.role?.code || 'N/A'}}</span>
                  </td>
                </ng-container>

                 <!-- Status Column -->
                 <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header> Status </th>
                    <td mat-cell *matCellDef="let row"> 
                      <span class="badge" [ngClass]="row.isDeactivated ? 'bg-danger' : 'bg-success'">
                        <mat-icon style="font-size: 14px; width: 14px; height: 14px; vertical-align: middle;">
                          {{row.isDeactivated ? 'block' : 'check_circle'}}
                        </mat-icon>
                        {{row.isDeactivated ? 'Deactivated' : 'Active'}}
                      </span>
                    </td>
                  </ng-container>

                 <!-- Created Date Column -->
                 <ng-container matColumnDef="createdAt">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header="createdAt"> Created </th>
                    <td mat-cell *matCellDef="let row"> 
                      <small>{{formatDate(row.createdAt)}}</small>
                    </td>
                  </ng-container>

                <!-- Actions Column -->
                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef> Actions </th>
                  <td mat-cell *matCellDef="let row">
                    <button mat-icon-button [matMenuTriggerFor]="menu" class="action-menu-button">
                      <mat-icon>more_vert</mat-icon>
                    </button>
                    
                    <mat-menu #menu="matMenu" class="action-menu">
                      <button mat-menu-item (click)="onViewStaff(row)" class="menu-item">
                        <i class="mdi mdi-18px mdi-eye-outline"></i>

                        <span>View Details</span>
                      </button>
                      
                      <button mat-menu-item (click)="onEditStaff(row)" class="menu-item">
                        <i class="mdi mdi-18px mdi-account-edit"></i>
                        <span>Edit Staff</span>
                      </button>
                      <button *ngIf="!row.isDeactivated" mat-menu-item (click)="onDeactivateStaff(row)" class="menu-item">
                        <i class="mdi mdi-18px mdi-account-cancel"></i>
                        <span>Deactivate</span>
                      </button>

                      <button *ngIf="row.isDeactivated" mat-menu-item (click)="onActivateStaff(row)" class="menu-item">
                        <i class="mdi mdi-18px mdi-account-check"></i>

                        <span>Activate</span>
                      </button>
                      
                      <mat-divider></mat-divider>
                      
                      <button mat-menu-item (click)="onDeleteStaff(row)" class="menu-item delete-action">
                        <i class="mdi mdi-18px mdi-trash-can"></i>
                        <span>Delete Staff</span>
                      </button>
                    </mat-menu>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>

                <!-- Row shown when there is no matching data. -->
                <tr class="mat-row" *matNoDataRow>
                  <td class="mat-cell text-center" [attr.colspan]="displayedColumns.length">
                    <div class="py-4">
                      <mat-icon class="text-muted" style="font-size: 48px;">people_outline</mat-icon>
                      <p class="text-muted mt-2">No staff members found</p>
                    </div>
                  </td>
                </tr>
              </table>
            </div>

            <!-- Pagination -->
            <div class="row justify-content-between align-items-center mt-3">
              <div class="col-md-6">
                <mat-paginator 
                  [length]="totalItems"
                  [pageSize]="pageSize"
                  [pageSizeOptions]="pageSizeOptions"
                  [pageIndex]="currentPage - 1"
                  (page)="onPageChange($event)"
                  aria-label="Select page of staff">
                </mat-paginator>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ... existing table content ... -->

<!-- Edit Modal Template -->
<ng-template #modalTemplate>
    <div class="p-3">
        <h2 mat-dialog-title class="d-flex align-items-center mb-3">
            <mat-icon class="me-2" [style.color]="isEditMode ? '#556ee6' : '#34c38f'">
                {{ isEditMode ? 'edit' : 'person_add' }}
            </mat-icon>
            {{ getModalTitle() }}
        </h2>
        
        <mat-dialog-content class="mat-typography">
            <form [formGroup]="staffForm">
                <div class="modal-body mt-3">
          <div class="row">
            <!-- First Name -->
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>First Name</mat-label>
                <input matInput formControlName="firstName" placeholder="Enter first name">
                <mat-error *ngIf="staffForm.get('firstName')?.hasError('required')">
                  First name is required
                </mat-error>
                <mat-error *ngIf="staffForm.get('firstName')?.hasError('minlength')">
                  First name must be at least 2 characters
                </mat-error>
              </mat-form-field>
            </div>
  
            <!-- Last Name -->
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Last Name</mat-label>
                <input matInput formControlName="lastName" placeholder="Enter last name">
                <mat-error *ngIf="staffForm.get('lastName')?.hasError('required')">
                  Last name is required
                </mat-error>
                <mat-error *ngIf="staffForm.get('lastName')?.hasError('minlength')">
                  Last name must be at least 2 characters
                </mat-error>
              </mat-form-field>
            </div>
          </div>
  
          <div class="row">
            <!-- Email -->
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Email</mat-label>
                <input matInput formControlName="email" placeholder="Enter email" type="email">
                <mat-error *ngIf="staffForm.get('email')?.hasError('required')">
                  Email is required
                </mat-error>
                <mat-error *ngIf="staffForm.get('email')?.hasError('email')">
                  Please enter a valid email
                </mat-error>
              </mat-form-field>
            </div>
  
            <!-- Phone with Country Code -->
            <div class="col-md-6">
              <div class="d-flex align-items-start">
                <!-- Country Code Dropdown -->
                <mat-form-field appearance="outline" class="me-2" style="width: 140px;">
                  <mat-label>Code</mat-label>
                  <mat-select formControlName="countryCode">
                    <mat-option *ngFor="let country of countryCodes" [value]="country.code">
                      <span class="me-2">{{country.flag}}</span>
                      <span>{{country.code}}</span>
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="staffForm.get('countryCode')?.hasError('required')">
                    Country code is required
                  </mat-error>
                </mat-form-field>
                
                <!-- Phone Number Input -->
                <mat-form-field appearance="outline" class="flex-grow-1">
                  <mat-label>Phone Number</mat-label>
                  <input matInput formControlName="phone" placeholder="Enter phone number">
                  <mat-error *ngIf="staffForm.get('phone')?.hasError('required')">
                    Phone number is required
                  </mat-error>
                  <mat-error *ngIf="staffForm.get('phone')?.hasError('pattern')">
                    Please enter a valid phone number (7-15 digits)
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </div>
  
          <div class="row">
            <!-- Role -->
            <div class="col-md-6">
              <mat-form-field appearance="outline" class="w-100">
                <mat-label>Role</mat-label>
                <mat-select formControlName="roleId">
                  <mat-option *ngFor="let role of roleOptions" [value]="role.code">
                    {{role.code}}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="staffForm.get('roleId')?.hasError('required')">
                  Role is required
                </mat-error>
              </mat-form-field>
            </div>
          </div>

          <div class="row">
            <!-- Profile Picture Upload -->
            <div class="col-md-12">
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  <mat-icon class="me-1" style="vertical-align: middle;">image</mat-icon>
                  Profile Picture
                </label>
                <div class="d-flex align-items-start mt-2">
                  <!-- Preview -->
                  <div class="me-3" *ngIf="profilePicturePreview">
                    <img [src]="profilePicturePreview" 
                         alt="Profile Preview" 
                         class="rounded-circle shadow-sm" 
                         style="width: 100px; height: 100px; object-fit: cover; border: 3px solid #e0e0e0;">
                  </div>
                  <div *ngIf="!profilePicturePreview && !selectedProfilePicture" class="me-3">
                    <div class="rounded-circle bg-light d-flex align-items-center justify-content-center shadow-sm"
                         style="width: 100px; height: 100px; border: 3px dashed #e0e0e0;">
                      <mat-icon style="font-size: 48px; width: 48px; height: 48px; color: #9e9e9e;">person</mat-icon>
                    </div>
                  </div>
                  
                  <!-- Upload Button -->
                  <div class="flex-grow-1">
                    <input 
                      #fileInput
                      type="file" 
                      id="profilePictureInput"
                      class="form-control" 
                      accept="image/jpeg,image/png,image/jpg,.jpg,.jpeg,.png"
                      (change)="onProfilePictureSelected($event)"
                      style="display: none;">
                    <div class="d-flex flex-wrap gap-2 mb-2">
                      <button 
                        type="button" 
                        mat-raised-button 
                        color="primary"
                        (click)="fileInput.click()">
                        <mat-icon>cloud_upload</mat-icon>
                        {{ selectedProfilePicture ? 'Change Picture' : 'Upload Picture' }}
                      </button>
                      <button 
                        type="button" 
                        mat-stroked-button 
                        color="warn"
                        *ngIf="selectedProfilePicture || profilePicturePreview"
                        (click)="removeProfilePicture()">
                        <mat-icon>delete</mat-icon>
                        Remove
                      </button>
                    </div>
                    <small class="d-block text-muted">
                      <mat-icon style="font-size: 14px; width: 14px; height: 14px; vertical-align: middle;">info</mat-icon>
                      Supported formats: JPG, JPEG, PNG only. Max size: 2MB
                    </small>
                  </div>
                </div>
              </div>
            </div>
          </div>
                </div>
            </form>
        </mat-dialog-content>
        
        <mat-dialog-actions align="end" class="px-4 pb-3">
            <button type="button" mat-stroked-button mat-dialog-close [disabled]="isSubmitting">
                <mat-icon>close</mat-icon>
                Cancel
            </button>
            <button type="button" (click)="onSubmitForm()" mat-raised-button color="primary" [disabled]="staffForm.invalid || isSubmitting">
                <mat-spinner diameter="20" *ngIf="isSubmitting" style="display: inline-block; margin-right: 8px;"></mat-spinner>
                <mat-icon *ngIf="!isSubmitting" class="me-1">{{ isEditMode ? 'save' : 'add' }}</mat-icon>
                <span *ngIf="!isSubmitting">{{ getSubmitButtonText() }}</span>
                <span *ngIf="isSubmitting">{{ isEditMode ? 'Updating...' : 'Creating...' }}</span>
            </button>
        </mat-dialog-actions>
    </div>
</ng-template>

